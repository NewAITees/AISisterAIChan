# デバッグガイド

このドキュメントでは、AI妹アイちゃんゴーストのデバッグ方法とログファイルの見方を説明します。

## ログファイルの場所

すべてのログファイルは `ghost/master/log/` ディレクトリに保存されます。

## ログファイルの種類

### 🔴 **必須ログ** - 問題発生時に最初に確認すべきログ

#### 1. `error.log` - エラーログ
**最優先で確認してください**。エラーや例外が発生した時の詳細情報が記録されます。

**内容:**
- エラー発生場所
- 例外の種類
- エラーメッセージ
- スタックトレース
- 内部例外（ある場合）

**フォーマット例:**
```
[2025-12-29 14:30:15.123] ERROR in BuildTalk
  Type: System.NullReferenceException
  Message: Object reference not set to an instance of an object.
  StackTrace: at AISisterAIChanGhost.BuildTalk(String response, Boolean createChoices, String log) in Ghost.csx:line 275
  InnerException: (none)
```

**確認するタイミング:**
- ゴーストが正常に動作しない時
- 会話が途中で止まった時
- SSPがクラッシュした時
- 変な動作をした時

---

#### 2. `shiori_events.log` - イベントログ
SHIORIイベント（起動、マウスクリック、会話など）の履歴が記録されます。

**内容:**
- 発生したイベント名
- イベントのパラメータ

**フォーマット例:**
```
[2025-12-29 14:28:00.456] Event: OnBoot | shellName=master, isHalt=False, haltGhostName=
[2025-12-29 14:28:45.789] Event: OnMouseDoubleClick | parts=頭
[2025-12-29 14:29:10.012] Event: OnClose | reason=user
```

**確認するタイミング:**
- イベントが正しく発火しているか確認したい時
- マウス操作が反応しない時
- ゴーストの動作フローを追いたい時

---

#### 3. `generated_scripts.log` - スクリプト生成ログ
生成された栞スクリプトが記録されます。

**内容:**
- どのイベントでスクリプトが生成されたか
- 生成されたスクリプトの内容

**フォーマット例:**
```
[2025-12-29 14:28:00.456] OnBoot => おかえり、おにいちゃん。\e
[2025-12-29 14:28:45.789] OnMouseDoubleClick => \s[0]うわっ、何するの！？\n\e
[2025-12-29 14:30:00.123] BuildTalk-Error => ごめん、エラーが発生しちゃった...\nログを確認してね。\e
```

**確認するタイミング:**
- セリフが表示されない時
- 表示が崩れている時
- エンドタグ（\e）が正しく付いているか確認したい時

---

### 🟡 **開発者モード限定ログ** - 詳細デバッグ用

開発者モードを有効にすると以下のログが出力されます。

#### 4. `prompt.txt` - LLMへのプロンプト
Ollamaに送信されるプロンプトの全文が記録されます。

**内容:**
- キャラクター設定
- 会話履歴
- 出力フォーマット指示

**確認するタイミング:**
- LLMの応答がおかしい時
- キャラクター設定が反映されているか確認したい時
- プロンプトを調整したい時

---

#### 5. `response.txt` - LLMからのレスポンス
Ollamaから返ってきた生のレスポンスが記録されます。

**内容:**
- AIのセリフ
- 表情カテゴリ
- 会話継続フラグ
- ユーザーのセリフ候補（ある場合）

**確認するタイミング:**
- LLMの出力フォーマットが正しいか確認したい時
- パース（解析）エラーが発生している時
- LLMがルールに従っているか確認したい時

---

### 🔵 **詳細JSONログ** - 内部状態の詳細確認用

以下のJSONログは、スクリプト生成の詳細なデバッグ情報を含みます。

#### 6. `boot_script_log.json` - 起動スクリプト詳細
#### 7. `close_script_log.json` - 終了スクリプト詳細
#### 8. `normal_waiting_script_log.json` - 会話待機中スクリプト
#### 9. `normal_choices_script_log.json` - 選択肢表示時スクリプト

**内容:**
- タイムスタンプ
- モード（OnBoot, NormalWaiting, etc.）
- 生成されたスクリプト
- スクリプト長
- エンドタグの有無
- バイト列（エンコーディング検証用）

**フォーマット例:**
```json
{
  "timestamp": "2025-12-29 14:28:00.456",
  "mode": "OnBoot",
  "generatedScript": "おかえり、おにいちゃん。\\e",
  "scriptLength": 20,
  "hasEndTag": true,
  "rawBytes": "E3 81 8A E3 81 8B..."
}
```

**確認するタイミング:**
- 文字化けが発生している時（rawBytesを確認）
- スクリプトが正しく終了していない時（hasEndTag）
- エンコーディング問題を調査したい時

---

## デバッグ手順

### 問題発生時の基本フロー

```
1. ❌ 問題発生

2. 📂 `error.log` を開く
   └─ エラーがある？
      ├─ YES → エラーメッセージとスタックトレースを確認
      └─ NO  → 3へ

3. 📂 `shiori_events.log` を開く
   └─ 期待したイベントが発火している？
      ├─ YES → 4へ
      └─ NO  → イベントハンドラーの問題

4. 📂 `generated_scripts.log` を開く
   └─ スクリプトが生成されている？
      ├─ YES → スクリプト内容を確認
      │         └─ `\e` が付いている？
      │            ├─ YES → SSP側の問題かも
      │            └─ NO  → スクリプト生成の問題
      └─ NO  → 5へ

5. 🔧 開発者モードを有効化
   └─ `prompt.txt` と `response.txt` を確認
      └─ LLMの応答は正常？
         ├─ YES → パース処理の問題
         └─ NO  → プロンプトまたはOllama の問題
```

---

## 開発者モードの有効化

1. ゴーストをダブルクリック（体以外の場所）
2. 「設定を変えたい」を選択
3. 「開発者モードを変更する」をクリック

開発者モードが有効になると、`prompt.txt` と `response.txt` が出力されるようになります。

---

## よくある問題とログの見方

### 🔍 **問題1: 会話が始まらない**

**確認するログ:**
1. `shiori_events.log` - `OnMouseDoubleClick` イベントが記録されているか
2. `error.log` - エラーが発生していないか

**原因候補:**
- Ollamaが起動していない
- モデルがダウンロードされていない
- ネットワークエラー

---

### 🔍 **問題2: セリフが表示されない**

**確認するログ:**
1. `generated_scripts.log` - スクリプトが生成されているか
2. `error.log` - BuildTalkでエラーが出ていないか
3. `response.txt`（開発モード） - LLMのレスポンスが正しいフォーマットか

**原因候補:**
- LLMが指定フォーマットに従っていない
- パース（解析）エラー
- スクリプトに`\e`が付いていない

---

### 🔍 **問題3: 文字化けが発生する**

**確認するログ:**
1. `boot_script_log.json` などの `rawBytes` フィールド
2. `error.log` - エンコーディング関連のエラー

**原因候補:**
- エンコーディング設定ミス（UTF-8 vs Shift_JIS）
- ファイル保存時のエンコーディングが間違っている

---

### 🔍 **問題4: 選択肢が表示されない**

**確認するログ:**
1. `normal_choices_script_log.json` - `choiceCount` が0でないか
2. `response.txt`（開発モード） - 「兄のセリフ候補」が含まれているか

**原因候補:**
- SaveDataの`ChoiceCount`が0に設定されている
- LLMが候補を生成していない

---

## ログのクリーンアップ

ログが大きくなりすぎた場合は、`ghost/master/log/` ディレクトリ内のファイルを削除しても問題ありません。次回起動時に自動的に再作成されます。

**推奨:**
- `error.log`, `shiori_events.log`, `generated_scripts.log` は定期的にアーカイブ
- JSONログは問題解決後に削除してOK

---

## トラブルシューティングチェックリスト

- [ ] Ollamaが起動しているか確認: `curl http://localhost:11434/v1/models`
- [ ] モデルがダウンロードされているか確認: `ollama list`
- [ ] `error.log` にエラーがないか確認
- [ ] `shiori_events.log` でイベントが発火しているか確認
- [ ] `generated_scripts.log` でスクリプトが生成されているか確認
- [ ] 開発者モードで `prompt.txt` と `response.txt` を確認
- [ ] SHIOLINKログ（`ghost/master/SHIOLINK.log`）を確認

---

## サポート

問題が解決しない場合は、以下の情報を添えて報告してください：
1. `error.log` の内容
2. 問題が発生した時の操作手順
3. Ollamaのモデル名とバージョン
4. SSPのバージョン
